<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ダッシュボード - 勤怠管理</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="/css/themes.css">
  <link rel="stylesheet" href="/styles.css">
  <link rel="stylesheet" href="/css/animations.css">
</head>
<body class="preload">
  <!-- Dark Mode Toggle -->
  <div class="theme-toggle" onclick="toggleTheme()" title="テーマ切り替え (Ctrl+K)">
    <i class="fas fa-moon" id="theme-icon"></i>
  </div>

  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <i class="fas fa-clock"></i>
        </div>
        <h2 class="sidebar-title">勤怠管理</h2>
      </div>

      <nav class="sidebar-nav">
        <a href="#" class="nav-item active" id="nav-dashboard" onclick="window.scrollTo({top:0,behavior:'smooth'});return false;">
          <i class="fas fa-home"></i>
          <span>ダッシュボード</span>
        </a>
        <a href="#" class="nav-item" id="nav-attendance" onclick="document.querySelector('.records').scrollIntoView({behavior:'smooth',block:'start'});return false;">
          <i class="fas fa-calendar-check"></i>
          <span>勤怠記録</span>
        </a>
        <a href="#" class="nav-item" id="nav-statistics" onclick="document.querySelector('.kpi-grid').scrollIntoView({behavior:'smooth',block:'start'});return false;">
          <i class="fas fa-chart-line"></i>
          <span>統計</span>
        </a>
        <a href="#" class="nav-item" id="nav-settings" onclick="alert('設定機能は準備中です');return false;">
          <i class="fas fa-cog"></i>
          <span>設定</span>
        </a>
      </nav>

      <div class="sidebar-footer">
        <div class="user-info" style="margin-bottom: 0; padding: 1rem; border: 1px solid var(--border-subtle); border-radius: var(--radius-lg);">
          <div class="user-avatar" id="sidebar-avatar">U</div>
          <div class="user-details">
            <p id="sidebar-name" style="font-size: 0.875rem;">読み込み中...</p>
            <p class="user-role" id="sidebar-role" style="font-size: 0.75rem;"></p>
          </div>
        </div>
        <button class="btn-primary" onclick="logout()" style="width: 100%; margin-top: 0.75rem;">
          <i class="fas fa-sign-out-alt"></i> ログアウト
        </button>
        <button id="admin-link-sidebar" class="btn-danger hidden" onclick="location.href='/admin'" style="width: 100%; margin-top: 0.5rem;">
          <i class="fas fa-user-shield"></i> 管理者画面
        </button>
      </div>
    </aside>

    <!-- Mobile Sidebar Toggle -->
    <button class="sidebar-toggle" onclick="toggleSidebar()">
      <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Bar with Notifications -->
      <div class="dashboard-topbar">
        <div class="topbar-search">
          <i class="fas fa-search"></i>
          <input type="text" placeholder="検索... (Ctrl+K)">
        </div>
        <div class="topbar-actions">
          <div class="notification-bell" onclick="toggleNotificationCenter()">
            <i class="fas fa-bell"></i>
            <span class="notification-badge" id="notification-count">3</span>
          </div>
          <div class="user-menu">
            <div class="user-avatar" id="user-avatar">U</div>
          </div>
        </div>
      </div>

      <!-- Notification Center -->
      <div class="notification-center hidden" id="notification-center">
        <div class="notification-header">
          <h3>通知</h3>
          <div class="notification-actions">
            <button onclick="markAllRead()">すべて既読</button>
            <button onclick="clearNotifications()">クリア</button>
          </div>
        </div>
        <div class="notification-list" id="notification-list">
          <!-- Notifications will be populated here -->
        </div>
      </div>

      <!-- Welcome Banner -->
      <div class="welcome-banner animate-fade-in-up">
        <div class="welcome-content">
          <h1 class="welcome-greeting" id="greeting">おはようございます</h1>
          <p class="welcome-time" id="current-time">--:--</p>
        </div>
      </div>

      <!-- KPI Cards Grid -->
      <div class="kpi-grid">
        <!-- Today's Work Hours -->
        <div class="kpi-card indigo stagger-item">
          <div class="kpi-header">
            <div class="kpi-icon">
              <i class="fas fa-clock"></i>
            </div>
          </div>
          <div class="kpi-body">
            <div class="kpi-value" id="today-hours">0</div>
            <div class="kpi-label">今日の勤務時間 (時間)</div>
          </div>
          <div class="kpi-footer">
            <div class="kpi-detail" id="today-status">未出勤</div>
          </div>
        </div>

        <!-- This Month's Days -->
        <div class="kpi-card cyan stagger-item">
          <div class="kpi-header">
            <div class="kpi-icon">
              <i class="fas fa-calendar-check"></i>
            </div>
            <div class="kpi-trend up">
              <i class="fas fa-arrow-up"></i>
              <span id="month-trend">+0</span>
            </div>
          </div>
          <div class="kpi-body">
            <div class="kpi-value" id="month-days">0</div>
            <div class="kpi-label">今月の勤務日数</div>
          </div>
          <div class="kpi-footer">
            <div class="kpi-detail">目標: 22日</div>
          </div>
        </div>

        <!-- Average Clock In Time -->
        <div class="kpi-card purple stagger-item">
          <div class="kpi-header">
            <div class="kpi-icon">
              <i class="fas fa-sun"></i>
            </div>
          </div>
          <div class="kpi-body">
            <div class="kpi-value" id="avg-clock-in" style="font-size: 1.5rem;">--:--</div>
            <div class="kpi-label">平均出勤時刻</div>
          </div>
          <div class="kpi-footer">
            <div class="kpi-detail">標準: 9:00</div>
          </div>
        </div>

        <!-- Total Hours This Month -->
        <div class="kpi-card orange stagger-item">
          <div class="kpi-header">
            <div class="kpi-icon">
              <i class="fas fa-business-time"></i>
            </div>
          </div>
          <div class="kpi-body">
            <div class="kpi-value" id="total-hours">0</div>
            <div class="kpi-label">今月の総勤務時間</div>
          </div>
          <div class="kpi-footer">
            <div class="kpi-detail">目標: 176時間</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="card animate-fade-in-up" style="animation-delay: 0.2s;">
        <h3><i class="fas fa-bolt"></i> クイックアクション</h3>
        <div class="buttons">
          <button class="btn-success" onclick="clockIn()">
            <i class="fas fa-sign-in-alt"></i> 出勤
          </button>
          <button class="btn-warning" onclick="breakStart()">
            <i class="fas fa-coffee"></i> 休憩開始
          </button>
          <button class="btn-primary" onclick="breakEnd()">
            <i class="fas fa-play"></i> 休憩終了
          </button>
          <button class="btn-danger" onclick="clockOut()">
            <i class="fas fa-sign-out-alt"></i> 退勤
          </button>
        </div>
      </div>

      <!-- Charts Grid -->
      <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem; margin: 2rem 0;">
        <!-- Weekly Hours Chart -->
        <div class="card animate-fade-in-up" style="animation-delay: 0.3s;">
          <h3><i class="fas fa-chart-bar"></i> 今週の勤務時間</h3>
          <canvas id="weeklyHoursChart" height="80"></canvas>
        </div>

        <!-- Two columns for medium+ screens -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 1.5rem;">
          <!-- Clock In/Out Trend -->
          <div class="card animate-fade-in-up" style="animation-delay: 0.4s;">
            <h3><i class="fas fa-chart-line"></i> 出退勤時刻の推移</h3>
            <canvas id="clockTrendChart" height="100"></canvas>
          </div>

          <!-- Work Distribution -->
          <div class="card animate-fade-in-up" style="animation-delay: 0.5s;">
            <h3><i class="fas fa-chart-pie"></i> 勤務時間の内訳</h3>
            <canvas id="workDistributionChart" height="100"></canvas>
          </div>
        </div>
      </div>

      <!-- Attendance Records -->
      <div class="records animate-fade-in-up" style="animation-delay: 0.6s;">
        <h3><i class="fas fa-table"></i> 勤怠記録</h3>
        <div class="table-wrapper">
          <table class="data-table">
            <thead>
              <tr>
                <th>日付</th>
                <th>出勤</th>
                <th>退勤</th>
                <th>休憩開始</th>
                <th>休憩終了</th>
                <th>勤務時間</th>
              </tr>
            </thead>
            <tbody id="records-body">
              <!-- Skeleton Loading -->
              <tr>
                <td><div class="skeleton skeleton-text"></div></td>
                <td><div class="skeleton skeleton-text"></div></td>
                <td><div class="skeleton skeleton-text"></div></td>
                <td><div class="skeleton skeleton-text"></div></td>
                <td><div class="skeleton skeleton-text"></div></td>
                <td><div class="skeleton skeleton-text"></div></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </main>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>

  <script>
    console.log('*** SCRIPT LOADING ***');
    let charts = {};

    // Setup navigation - execute immediately since script is at bottom
    console.log('*** SETTING UP NAVIGATION ***');

    // Dashboard navigation
    const navDashboard = document.getElementById('nav-dashboard');
    console.log('nav-dashboard element:', navDashboard);
    if (navDashboard) {
      navDashboard.onclick = function(e) {
        console.log('*** DASHBOARD CLICKED ***');
        e.preventDefault();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return false;
      };
      console.log('Dashboard handler set');
    } else {
      console.error('nav-dashboard NOT FOUND');
    }

    // Attendance navigation
    const navAttendance = document.getElementById('nav-attendance');
    console.log('nav-attendance element:', navAttendance);
    if (navAttendance) {
      navAttendance.onclick = function(e) {
        console.log('*** ATTENDANCE CLICKED ***');
        e.preventDefault();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        const target = document.querySelector('.records');
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        return false;
      };
      console.log('Attendance handler set');
    } else {
      console.error('nav-attendance NOT FOUND');
    }

    // Statistics navigation
    const navStatistics = document.getElementById('nav-statistics');
    console.log('nav-statistics element:', navStatistics);
    if (navStatistics) {
      navStatistics.onclick = function(e) {
        console.log('*** STATISTICS CLICKED ***');
        e.preventDefault();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        const target = document.querySelector('.kpi-grid');
        if (target) {
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        return false;
      };
      console.log('Statistics handler set');
    } else {
      console.error('nav-statistics NOT FOUND');
    }

    // Settings navigation
    const navSettings = document.getElementById('nav-settings');
    console.log('nav-settings element:', navSettings);
    if (navSettings) {
      navSettings.onclick = function(e) {
        console.log('*** SETTINGS CLICKED ***');
        e.preventDefault();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        alert('設定機能は準備中です');
        return false;
      };
      console.log('Settings handler set');
    } else {
      console.error('nav-settings NOT FOUND');
    }

    console.log('*** NAVIGATION SETUP COMPLETE ***');

    // Sidebar Toggle
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // Theme Toggle (from app.js)
    function toggleTheme() {
      if (window.App && window.App.themeManager) {
        window.App.themeManager.toggle();
      }
    }

    // Update Time
    function updateTime() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
      const greeting = window.App ? window.App.getGreeting() : 'こんにちは';

      document.getElementById('current-time').textContent = timeStr;
      document.getElementById('greeting').textContent = greeting;
    }

    setInterval(updateTime, 1000);
    updateTime();

    // Authentication Check
    async function checkAuth() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) {
          alert('ログインが必要です');
          location.href = '/';
          return;
        }

        const user = await res.json();

        // Update user info in sidebar
        const initials = user.username.substring(0, 2).toUpperCase();
        document.getElementById('sidebar-avatar').textContent = initials;
        document.getElementById('sidebar-name').textContent = user.full_name || user.username;
        document.getElementById('sidebar-role').textContent = user.role === 'admin' ? '管理者' : 'ユーザー';

        // Show admin link if admin
        if (user.role === 'admin') {
          document.getElementById('admin-link-sidebar').classList.remove('hidden');
        }

        // Load data
        await Promise.all([
          loadRecords(),
          loadStatistics()
        ]);

        initializeCharts();
      } catch (error) {
        console.error('認証エラー:', error);
        alert('認証エラーが発生しました');
        location.href = '/';
      }
    }

    // Load Statistics
    async function loadStatistics() {
      try {
        const res = await fetch('/api/attendance/records');
        const records = await res.json();

        if (!Array.isArray(records) || records.length === 0) {
          return;
        }

        // Calculate statistics
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const thisMonth = now.getMonth();
        const thisYear = now.getFullYear();

        // Today's hours
        const todayRecord = records.find(r => {
          const recordDate = new Date(r.clock_in);
          return recordDate.toDateString() === today.toDateString();
        });

        if (todayRecord) {
          const clockIn = new Date(todayRecord.clock_in);
          const clockOut = todayRecord.clock_out ? new Date(todayRecord.clock_out) : new Date();
          const hours = ((clockOut - clockIn) / (1000 * 60 * 60)).toFixed(1);

          window.App.animateNumber(document.getElementById('today-hours'), parseFloat(hours), 1000);
          document.getElementById('today-status').textContent = todayRecord.clock_out ? '退勤済み' : '勤務中';
        }

        // This month's records
        const monthRecords = records.filter(r => {
          const recordDate = new Date(r.clock_in);
          return recordDate.getMonth() === thisMonth && recordDate.getFullYear() === thisYear;
        });

        const monthDays = monthRecords.length;
        window.App.animateNumber(document.getElementById('month-days'), monthDays, 1000);
        document.getElementById('month-trend').textContent = `+${monthDays}`;

        // Average clock-in time
        const clockInTimes = monthRecords.map(r => {
          const date = new Date(r.clock_in);
          return date.getHours() + date.getMinutes() / 60;
        });

        if (clockInTimes.length > 0) {
          const avgTime = clockInTimes.reduce((a, b) => a + b, 0) / clockInTimes.length;
          const hours = Math.floor(avgTime);
          const minutes = Math.round((avgTime - hours) * 60);
          document.getElementById('avg-clock-in').textContent =
            `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // Total hours this month
        let totalHours = 0;
        monthRecords.forEach(r => {
          if (r.clock_out) {
            const clockIn = new Date(r.clock_in);
            const clockOut = new Date(r.clock_out);
            totalHours += (clockOut - clockIn) / (1000 * 60 * 60);
          }
        });

        window.App.animateNumber(document.getElementById('total-hours'), Math.round(totalHours), 1000);

      } catch (error) {
        console.error('統計読み込みエラー:', error);
      }
    }

    // Load Attendance Records
    async function loadRecords() {
      try {
        const res = await fetch('/api/attendance/records');
        const records = await res.json();
        const tbody = document.getElementById('records-body');

        if (!Array.isArray(records) || records.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem; color: var(--text-tertiary);">記録がありません</td></tr>';
          return records || [];
        }

        tbody.innerHTML = records.map(r => {
          const clockIn = r.clock_in ? new Date(r.clock_in) : null;
          const clockOut = r.clock_out ? new Date(r.clock_out) : null;
          const workHours = clockIn && clockOut ?
            ((clockOut - clockIn) / (1000 * 60 * 60)).toFixed(1) : '-';

          return `
            <tr class="stagger-item">
              <td>${clockIn ? clockIn.toLocaleDateString('ja-JP') : '-'}</td>
              <td>${clockIn ? clockIn.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) : '-'}</td>
              <td>${clockOut ? clockOut.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) : '-'}</td>
              <td>${r.break_start ? new Date(r.break_start).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) : '-'}</td>
              <td>${r.break_end ? new Date(r.break_end).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'}) : '-'}</td>
              <td><strong>${workHours}${workHours !== '-' ? 'h' : ''}</strong></td>
            </tr>
          `;
        }).join('');

        return records;
      } catch (error) {
        console.error('記録読み込みエラー:', error);
        return [];
      }
    }

    // Initialize Charts
    async function initializeCharts() {
      const records = await loadRecords();
      if (!records || records.length === 0) return;

      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      const textColor = isDark ? '#f1f5f9' : '#1f2937';
      const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

      const chartDefaults = {
        responsive: true,
        maintainAspectRatio: true,
        plugins: {
          legend: {
            labels: {
              color: textColor,
              font: { size: 12, family: 'Inter, sans-serif' }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: textColor },
            grid: { color: gridColor }
          },
          y: {
            ticks: { color: textColor },
            grid: { color: gridColor }
          }
        }
      };

      // Weekly Hours Chart
      const weeklyData = getWeeklyData(records);
      if (charts.weekly) charts.weekly.destroy();
      charts.weekly = new Chart(document.getElementById('weeklyHoursChart'), {
        type: 'bar',
        data: {
          labels: ['月', '火', '水', '木', '金', '土', '日'],
          datasets: [{
            label: '勤務時間',
            data: weeklyData,
            backgroundColor: [
              'rgba(99, 102, 241, 0.8)',   // Monday - Indigo
              'rgba(168, 85, 247, 0.8)',   // Tuesday - Purple
              'rgba(6, 182, 212, 0.8)',    // Wednesday - Cyan
              'rgba(16, 185, 129, 0.8)',   // Thursday - Green
              'rgba(251, 146, 60, 0.8)',   // Friday - Orange
              'rgba(236, 72, 153, 0.8)',   // Saturday - Pink
              'rgba(251, 191, 36, 0.8)'    // Sunday - Yellow
            ],
            borderColor: [
              'rgba(99, 102, 241, 1)',
              'rgba(168, 85, 247, 1)',
              'rgba(6, 182, 212, 1)',
              'rgba(16, 185, 129, 1)',
              'rgba(251, 146, 60, 1)',
              'rgba(236, 72, 153, 1)',
              'rgba(251, 191, 36, 1)'
            ],
            borderWidth: 2,
            borderRadius: 8
          }]
        },
        options: {...chartDefaults, scales: {...chartDefaults.scales, x: chartDefaults.scales.x, y: {...chartDefaults.scales.y, beginAtZero: true}}}
      });

      // Clock Trend Chart
      const trendData = getTrendData(records);
      if (charts.trend) charts.trend.destroy();
      charts.trend = new Chart(document.getElementById('clockTrendChart'), {
        type: 'line',
        data: {
          labels: trendData.labels,
          datasets: [{
            label: '出勤時刻',
            data: trendData.clockIn,
            borderColor: 'rgba(6, 182, 212, 1)',  // Cyan
            backgroundColor: 'rgba(6, 182, 212, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
          }, {
            label: '退勤時刻',
            data: trendData.clockOut,
            borderColor: 'rgba(251, 146, 60, 1)',  // Orange
            backgroundColor: 'rgba(251, 146, 60, 0.1)',
            tension: 0.4,
            fill: true,
            borderWidth: 3
          }]
        },
        options: chartDefaults
      });

      // Work Distribution Chart
      const distribution = getDistributionData(records);
      if (charts.distribution) charts.distribution.destroy();
      charts.distribution = new Chart(document.getElementById('workDistributionChart'), {
        type: 'doughnut',
        data: {
          labels: ['通常勤務', '早出', '残業', '休憩'],
          datasets: [{
            data: distribution,
            backgroundColor: [
              'rgba(99, 102, 241, 0.9)',   // Indigo - 通常勤務
              'rgba(6, 182, 212, 0.9)',    // Cyan - 早出
              'rgba(251, 146, 60, 0.9)',   // Orange - 残業
              'rgba(168, 85, 247, 0.9)'    // Purple - 休憩
            ],
            borderColor: [
              'rgba(99, 102, 241, 1)',
              'rgba(6, 182, 212, 1)',
              'rgba(251, 146, 60, 1)',
              'rgba(168, 85, 247, 1)'
            ],
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              position: 'bottom',
              labels: {
                color: textColor,
                padding: 15,
                font: { size: 12 }
              }
            }
          }
        }
      });
    }

    // Helper functions for chart data
    function getWeeklyData(records) {
      const today = new Date();
      const weekData = [0, 0, 0, 0, 0, 0, 0];

      records.forEach(r => {
        if (r.clock_in && r.clock_out) {
          const date = new Date(r.clock_in);
          const dayOfWeek = (date.getDay() + 6) % 7; // Monday = 0
          const hours = (new Date(r.clock_out) - date) / (1000 * 60 * 60);
          weekData[dayOfWeek] += hours;
        }
      });

      return weekData.map(h => h.toFixed(1));
    }

    function getTrendData(records) {
      const last7 = records.slice(-7);
      return {
        labels: last7.map(r => new Date(r.clock_in).toLocaleDateString('ja-JP', {month: 'short', day: 'numeric'})),
        clockIn: last7.map(r => {
          const d = new Date(r.clock_in);
          return d.getHours() + d.getMinutes() / 60;
        }),
        clockOut: last7.map(r => {
          if (!r.clock_out) return null;
          const d = new Date(r.clock_out);
          return d.getHours() + d.getMinutes() / 60;
        })
      };
    }

    function getDistributionData(records) {
      let normal = 0, early = 0, overtime = 0, breaks = 0;

      records.forEach(r => {
        if (!r.clock_out) return;

        const clockIn = new Date(r.clock_in);
        const clockOut = new Date(r.clock_out);
        const totalHours = (clockOut - clockIn) / (1000 * 60 * 60);

        // Calculate break time if exists
        let breakHours = 0;
        if (r.break_start && r.break_end) {
          breakHours = (new Date(r.break_end) - new Date(r.break_start)) / (1000 * 60 * 60);
          breaks += breakHours;
        }

        // Net working hours (excluding breaks)
        const workHours = totalHours - breakHours;

        // Check if early (clock in before 9:00)
        const clockInHour = clockIn.getHours() + clockIn.getMinutes() / 60;
        if (clockInHour < 9 && workHours > 0) {
          const earlyHours = Math.min(9 - clockInHour, workHours);
          early += earlyHours;
        }

        // Split into normal (8h) and overtime
        if (workHours <= 8) {
          normal += workHours;
        } else {
          normal += 8;
          overtime += workHours - 8;
        }
      });

      return [normal.toFixed(1), early.toFixed(1), overtime.toFixed(1), breaks.toFixed(1)];
    }

    // Attendance Actions
    async function clockIn() {
      try {
        const res = await fetch('/api/attendance/clock-in', { method: 'POST' });
        const data = await res.json();
        window.App.showToast(data.message || data.error, res.ok ? 'success' : 'error');
        if (res.ok) {
          await loadRecords();
          await loadStatistics();
          initializeCharts();
        }
      } catch (error) {
        window.App.showToast('エラーが発生しました', 'error');
      }
    }

    async function clockOut() {
      try {
        const res = await fetch('/api/attendance/clock-out', { method: 'POST' });
        const data = await res.json();
        window.App.showToast(data.message || data.error, res.ok ? 'success' : 'error');
        if (res.ok) {
          await loadRecords();
          await loadStatistics();
          initializeCharts();
        }
      } catch (error) {
        window.App.showToast('エラーが発生しました', 'error');
      }
    }

    async function breakStart() {
      try {
        const res = await fetch('/api/attendance/break-start', { method: 'POST' });
        const data = await res.json();
        window.App.showToast(data.message || data.error, res.ok ? 'success' : 'error');
      } catch (error) {
        window.App.showToast('エラーが発生しました', 'error');
      }
    }

    async function breakEnd() {
      try {
        const res = await fetch('/api/attendance/break-end', { method: 'POST' });
        const data = await res.json();
        window.App.showToast(data.message || data.error, res.ok ? 'success' : 'error');
      } catch (error) {
        window.App.showToast('エラーが発生しました', 'error');
      }
    }

    async function logout() {
      await fetch('/api/auth/logout', { method: 'POST' });
      location.href = '/';
    }

    // Notification Center
    let notifications = [
      { id: 1, type: 'success', title: '出勤完了', message: '本日の出勤が記録されました', time: '2分前', unread: true },
      { id: 2, type: 'info', title: '週報提出', message: '今週の週報を提出してください', time: '1時間前', unread: true },
      { id: 3, type: 'warning', title: '勤務時間超過', message: '今月の残業時間が20時間を超えています', time: '3時間前', unread: true }
    ];

    function toggleNotificationCenter() {
      const center = document.getElementById('notification-center');
      center.classList.toggle('hidden');
      if (!center.classList.contains('hidden')) {
        renderNotifications();
      }
    }

    function renderNotifications() {
      const list = document.getElementById('notification-list');
      const count = document.getElementById('notification-count');

      const unreadCount = notifications.filter(n => n.unread).length;
      count.textContent = unreadCount;
      count.style.display = unreadCount > 0 ? 'flex' : 'none';

      list.innerHTML = notifications.map(n => `
        <div class="notification-item ${n.unread ? 'unread' : ''}" onclick="markAsRead(${n.id})">
          <div class="notification-icon ${n.type}">
            <i class="fas fa-${n.type === 'success' ? 'check' : n.type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
          </div>
          <div class="notification-content">
            <p class="notification-title">${n.title}</p>
            <p class="notification-message">${n.message}</p>
            <p class="notification-time">${n.time}</p>
          </div>
        </div>
      `).join('');
    }

    function markAsRead(id) {
      const notification = notifications.find(n => n.id === id);
      if (notification) {
        notification.unread = false;
        renderNotifications();
      }
    }

    function markAllRead() {
      notifications.forEach(n => n.unread = false);
      renderNotifications();
      window.App.showToast('すべて既読にしました', 'success');
    }

    function clearNotifications() {
      notifications = [];
      renderNotifications();
      toggleNotificationCenter();
      window.App.showToast('通知をクリアしました', 'info');
    }

    // Initialize on load
    checkAuth();
    renderNotifications();
  </script>

  <!-- App Utilities -->
  <script src="/js/app.js"></script>

  <!-- Navigation Setup - MUST be after app.js -->
  <script>
    console.log('*** FINAL NAVIGATION SETUP ***');
    // Wait a moment for app.js to finish
    setTimeout(function() {
      document.getElementById('nav-dashboard').onclick = function(e) {
        console.log('DASHBOARD CLICKED!');
        e.preventDefault();
        e.stopPropagation();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        window.scrollTo({ top: 0, behavior: 'smooth' });
        return false;
      };

      document.getElementById('nav-attendance').onclick = function(e) {
        console.log('ATTENDANCE CLICKED!');
        e.preventDefault();
        e.stopPropagation();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        document.querySelector('.records').scrollIntoView({ behavior: 'smooth', block: 'start' });
        return false;
      };

      document.getElementById('nav-statistics').onclick = function(e) {
        console.log('STATISTICS CLICKED!');
        e.preventDefault();
        e.stopPropagation();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        document.querySelector('.kpi-grid').scrollIntoView({ behavior: 'smooth', block: 'start' });
        return false;
      };

      document.getElementById('nav-settings').onclick = function(e) {
        console.log('SETTINGS CLICKED!');
        e.preventDefault();
        e.stopPropagation();
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        this.classList.add('active');
        alert('設定機能は準備中です');
        return false;
      };
      console.log('*** ALL HANDLERS SET ***');
    }, 100);
  </script>
</body>
</html>
